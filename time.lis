     1                                  ;****************************************************************************************************************************
     2                                  ;Program name: "Assignment 4".  This program greets a user by their inputted name  *
     3                                  ;and title.  Copyright (C) 2021  Gabriel Gamboa                                                                                 *
     4                                  ;This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License  *
     5                                  ;version 3 as published by the Free Software Foundation.                                                                    *
     6                                  ;This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied         *
     7                                  ;warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.     *
     8                                  ;A copy of the GNU General Public License v3 is available here:  <https://www.gnu.org/licenses/>.                           *
     9                                  ;****************************************************************************************************************************
    10                                  
    11                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2=========3=========4=========5=========6=========7**
    12                                  ;Author information
    13                                  ;  Author name: Gabriel Gamboa
    14                                  ;  Author email: gabe04@csu.fullerton.edu
    15                                  ;
    16                                  ;Program information
    17                                  ; Program name: Assignment 5
    18                                  ;  Programming languages X86 with one module in C and one module in C++
    19                                  ;  Date program began 2021-Dec-05
    20                                  ;  Date program completed 2021-Dec-14
    21                                  ;
    22                                  ;Purpose
    23                                  ;  This program takes the value of resistance and current and
    24                                  ;  returns the power computation if inputs are valid, otherwise
    25                                  ;  it tells user to try again
    26                                  ;Project information
    27                                  ;  Files: maxwell.c, hertz.asm, r.sh
    28                                  ;  Status: The program has been tested extensively with no detectable errors.
    29                                  ;
    30                                  ;Translator information
    31                                  ;  Linux: nasm -f elf64 -l hertz.lis -o hertz.o hertz.asm
    32                                  
    33                                  
    34                                  ;============================================================================================================================================================
    35                                  
    36                                  
    37                                  ;===== Begin code area ============================================================================================================
    38                                  extern printf
    39                                  extern scanf
    40                                  extern fgets
    41                                  extern strlen
    42                                  extern stdin
    43                                  extern atof
    44                                  extern ispositivefloat
    45                                  extern getfreq
    46                                  extern clock_speed
    47                                  global execution
    48                                  
    49                                  
    50                                  segment .data
    51                                  align 16
    52 00000000 546865206375727265-     clock_time db "The current clock time is %ld tics", 10, 0
    52 00000009 6E7420636C6F636B20-
    52 00000012 74696D652069732025-
    52 0000001B 6C6420746963730A00 
    53 00000024 4761627269656C2077-     farewell_message db "Gabriel wishes you a Nice Day.", 10, 0
    53 0000002D 697368657320796F75-
    53 00000036 2061204E6963652044-
    53 0000003F 61792E0A00         
    54 00000044 496E76616C69642069-     mess db "Invalid input detected.  You may run this program again", 10, 0
    54 0000004D 6E7075742064657465-
    54 00000056 637465642E2020596F-
    54 0000005F 75206D61792072756E-
    54 00000068 20746869732070726F-
    54 00000071 6772616D2061676169-
    54 0000007A 6E0A00             
    55 0000007D 506C6561736520656E-     heightprompt db "Please enter the height in meters of the dropped marble: ", 0
    55 00000086 746572207468652068-
    55 0000008F 656967687420696E20-
    55 00000098 6D6574657273206F66-
    55 000000A1 207468652064726F70-
    55 000000AA 706564206D6172626C-
    55 000000B3 653A2000           
    56 000000B7 546865206D6172626C-     marble_time db "The marble will reach the earth after %5.9lf seconds.", 10, 0
    56 000000C0 652077696C6C207265-
    56 000000C9 616368207468652065-
    56 000000D2 617274682061667465-
    56 000000DB 722025352E396C6620-
    56 000000E4 7365636F6E64732E0A-
    56 000000ED 00                 
    57 000000EE 546865206578656375-     exec_time db "The execution time was %ld tics which equals %5.9lf ns", 10, 0
    57 000000F7 74696F6E2074696D65-
    57 00000100 2077617320256C6420-
    57 00000109 746963732077686963-
    57 00000112 6820657175616C7320-
    57 0000011B 25352E396C66206E73-
    57 00000124 0A00               
    58 00000126 256C6600                one_float_format db "%lf",0
    59 0000012A 257300                  stringform db "%s", 0
    60 0000012D 90<rep 13h>             align 64
    61                                  segment .bss  ;Reserved for uninitialized data
    62                                  
    63 00000000 <res 100h>              programmers_name resb 256                  ;256 byte space created
    64 00000100 <res 100h>              height_string resb 256                        ;256 byte space created
    65 00000200 <res 100h>              cur_string resb 256                        ;256 byte space created
    66                                  
    67                                  segment .text ;Reserved for executing instructions.
    68                                  
    69                                  execution:
    70                                  
    71                                  ;=============================================================================================
    72                                  ;back up data in registers
    73 00000000 55                      push rbp
    74 00000001 4889E5                  mov  rbp,rsp
    75 00000004 57                      push rdi                                                    ;Backup rdi
    76 00000005 56                      push rsi                                                    ;Backup rsi
    77 00000006 52                      push rdx                                                    ;Backup rdx
    78 00000007 51                      push rcx                                                    ;Backup rcx
    79 00000008 4150                    push r8                                                     ;Backup r8
    80 0000000A 4151                    push r9                                                     ;Backup r9
    81 0000000C 4152                    push r10                                                    ;Backup r10
    82 0000000E 4153                    push r11                                                    ;Backup r11
    83 00000010 4154                    push r12                                                    ;Backup r12
    84 00000012 4155                    push r13                                                    ;Backup r13
    85 00000014 4156                    push r14                                                    ;Backup r14
    86 00000016 4157                    push r15                                                    ;Backup r15
    87 00000018 53                      push rbx                                                    ;Backup rbx
    88 00000019 9C                      pushf                                                       ;Backup rflags
    89                                  
    90                                  
    91                                  
    92                                  ;======Get clock time ========================================================================================================================
    93                                  
    94                                  ;this gets information about the clock
    95                                  ;info stored is clock_time in tics
    96 0000001A B800000000              mov rax, 0
    97 0000001F BA00000000              mov rdx, 0
    98                                  
    99 00000024 0FA2                    cpuid                              ; Identifies the type of cpu being used on pc.
   100 00000026 0F31                    rdtsc                              ; Counts the number of cycles/tics occured since pc reset.
   101                                  
   102 00000028 48C1E220                shl rdx, 32
   103 0000002C 4801D0                  add rax, rdx            ;info stored here in rax is clock_time (value) in tics
   104 0000002F 4989C6                  mov r14, rax
   105                                  
   106                                  
   107                                  
   108                                  ;====================================================================================================================================================
   109                                  
   110 00000032 B800000000              mov rax, 0
   111 00000037 48BF-                   mov rdi, clock_time               ;"The current clock time is tics"
   111 00000039 [0000000000000000] 
   112 00000041 4C89F6                  mov rsi, r14
   113 00000044 E8(00000000)            call printf
   114                                  
   115                                  
   116                                  
   117                                  ;===================Prompt user for marble height ===================================================================================================================================================
   118                                  
   119 00000049 B800000000              mov rax, 0                            ;format for printf, no floats used
   120 0000004E 48BF-                   mov rdi, heightprompt                 ;"Please enter the height in meters of the dropped marble: "
   120 00000050 [7D00000000000000] 
   121 00000058 E8(00000000)            call printf
   122                                  
   123                                  
   124                                  ;===== Obtain the marble height value and validate=============================================================================================================================================
   125                                  
   126                                  ;set up scanf for height_string
   127 0000005D B800000000              mov rax, 0
   128 00000062 48BF-                   mov rdi, stringform
   128 00000064 [2A01000000000000] 
   129 0000006C 48BE-                   mov rsi, height_string
   129 0000006E [0001000000000000] 
   130 00000076 E8(00000000)            call scanf
   131                                  
   132                                  
   133                                  ;check input value for float
   134                                  ;mov rax, 0
   135                                  ;mov rdi, height_string
   136                                  ;call ispositivefloat
   137 0000007B 4989C5                  mov r13, rax            ;r15 {0 is invalid, 1 is valid}
   138                                  
   139                                  ;check whether input is valid or not
   140 0000007E 4983FD00                cmp r13, 0
   141 00000082 7522                    jne validprocess
   142                                  
   143                                  ;message run again
   144 00000084 B800000000              mov rax, 0
   145 00000089 48BF-                   mov rdi, mess       ;"Invalid input detected.  You may run this program again"
   145 0000008B [4400000000000000] 
   146 00000093 E8(00000000)            call printf
   147                                  
   148                                  ;create -1.0 to return to driver for invalid inputs
   149 00000098 6AFF                    push qword -1
   150 0000009A F2440F2A3424            cvtsi2sd xmm14, [rsp]   ;convert -1 to -1.0 and store it in xmmm15
   151 000000A0 58                      pop rax
   152                                  
   153 000000A1 E9ED000000              jmp continue
   154                                  
   155                                  ;if valid, convert string to float
   156                                  validprocess:
   157 000000A6 B800000000              mov rax, 0
   158 000000AB 48BF-                   mov rdi, height_string        ;mov height_string to rdi and convert it to a float
   158 000000AD [0001000000000000] 
   159 000000B5 E8(00000000)            call atof
   160 000000BA F2440F10F8              movsd xmm15, xmm0
   161                                  ;Done w/ input data validation
   162                                  
   163                                  ;============================================================================================================================================================================================
   164                                  
   165                                  
   166                                  ;============= Begin arithmetic section  ===============================================================
   167                                  ;divide 98 by 10 to get 9.8 needed in formula
   168 000000BF 6A62                    push qword 98
   169 000000C1 F2440F2A3424            cvtsi2sd xmm14, [rsp]   ;convert 98 to 98.0 and store it in xmmm15
   170 000000C7 58                      pop rax
   171                                  
   172                                  ;push 10 to divide 98 by it to get 9.8 needed in formula
   173 000000C8 6A0A                    push qword 10
   174 000000CA F2440F2A2C24            cvtsi2sd xmm13, [rsp]   ;convert 10 to 10.0 and store it in xmmm15
   175 000000D0 58                      pop rax
   176                                  
   177                                  ;divide 98 by 10 and store it in xmm14
   178 000000D1 F2450F5EF5              divsd xmm14, xmm13      ;xmm14 contains 9.8
   179                                  
   180                                  ;push 2 onto stack to convert to 2.0 and use 2.0 neeeded in formula
   181 000000D6 6A02                    push qword 2
   182 000000D8 F2440F2A2C24            cvtsi2sd xmm13, [rsp]   ;convert 2 to 2.0 and store it in xmm13
   183 000000DE 58                      pop rax
   184                                  
   185                                  ;do calculations of how long it will take marble to reach earth from height
   186                                  ;and print out
   187 000000DF B801000000              mov rax, 1              ;1 floating point number will be passed into printf
   188 000000E4 48BF-                   mov rdi, marble_time     ;"The marble will reach the earth after %5.9lf seconds."
   188 000000E6 [B700000000000000] 
   189 000000EE F2450F5EF5              divsd xmm14, xmm13       ; xmm14 is divided by 2.0, and answer is stored in xmm14
   190 000000F3 F2450F5EFE              divsd xmm15, xmm14       ;Meters inputted is divided by G/2 and stored in xmm15
   191 000000F8 F2450F51FF              sqrtsd xmm15, xmm15       ;sqrt of xmm15 is taken and stored in xmm15 (time in secs to reach earth)
   192 000000FD F2410F10C7              movsd xmm0, xmm15
   193 00000102 E8(00000000)            call printf
   194                                  ;pop rax
   195                                  
   196                                  
   197                                  ;============= End of arightmetic section ==============================================================
   198                                  
   199                                  ;======Get clock time ========================================================================================================================
   200                                  
   201                                  ;this gets information about the clock
   202                                  ;info stored is clock_time in tics
   203 00000107 B800000000              mov rax, 0
   204 0000010C BA00000000              mov rdx, 0
   205                                  
   206 00000111 0FA2                    cpuid                              ; Identifies the type of cpu being used on pc.
   207 00000113 0F31                    rdtsc                              ; Counts the number of cycles/tics occured since pc reset.
   208                                  
   209 00000115 48C1E220                shl rdx, 32
   210 00000119 4801D0                  add rax, rdx                      ;info stored here in rax is clock_time (value) in tics
   211 0000011C 4989C7                  mov r15, rax
   212                                  
   213                                  ;====================================================================================================================================================
   214                                  
   215                                  ;output current clock time in tics
   216 0000011F B800000000              mov rax, 0
   217 00000124 48BF-                   mov rdi, clock_time             ;"The current clock time is %ld tics"
   217 00000126 [0000000000000000] 
   218 0000012E 4C89FE                  mov rsi, r15                    ;r15 has clock time in tics
   219 00000131 E8(00000000)            call printf
   220                                  
   221                                  ;====================================================================================================================================================
   222                                  
   223                                  ;call clock_speed to get value of processor in GHz
   224                                  ;we wiil use this to convert our exectution time from tics to nanoseconds
   225                                  ;to do this we divide # of tics by top processor spped
   226                                  ;this will give us execution time value in seconds
   227                                  ;
   228 00000136 B800000000              mov rax, 0
   229 0000013B E8(00000000)            call clock_speed            ;function that returns value of max processor speed in xmm0
   230 00000140 F2440F10F8              movsd xmm15, xmm0           ;store max processor speed in xmm15
   231 00000145 F24D0F2AF7              cvtsi2sd xmm14, r15         ;r15 holds exec time, we convert to float in xmm14 to use in calculations
   232 0000014A F2450F5EF7              divsd xmm14, xmm15          ;divide xmm14 by xmm15 (max processor speed) to
   233                                                              ;get execution time in seconds
   234                                  
   235                                  ;get one billion = 1 000 000 000 in xmm13 to multiply by xmm14 to go from seconds to nanoseconds
   236 0000014F 6800CA9A3B              push qword 1000000000
   237 00000154 F2440F2A2C24            cvtsi2sd xmm13, [rsp]
   238 0000015A 58                      pop rax
   239                                  
   240                                  
   241 0000015B B801000000              mov rax, 1
   242 00000160 48BF-                   mov rdi, exec_time               ;"The execution time was %ld which equals ns"
   242 00000162 [EE00000000000000] 
   243 0000016A 4D29F7                  sub r15, r14                ;r14 holds original clock time. subtracting r15 by r14 will give us execution time
   244 0000016D 4C89FE                  mov rsi, r15                ;might be some error here. Not sure how having an integer and float in same
   245 00000170 F2450F59F5              mulsd xmm14, xmm13          ;xmm14 holds execution time in nanoseconds now
   246 00000175 F2410F10C6              movsd xmm0, xmm14           ;call will affect things
   247 0000017A E8(00000000)            call printf
   248                                  
   249                                  
   250                                  
   251                                  
   252                                  ;====================================================================================================================================================
   253                                  
   254                                  ;farewell from asm message
   255 0000017F B800000000              mov rax, 0
   256 00000184 48BF-                   mov rdi, farewell_message      ;"Gabriel wishes you a nice day"
   256 00000186 [2400000000000000] 
   257 0000018E E8(00000000)            call printf
   258                                  
   259                                  
   260                                  
   261                                  ;============================================================================================================
   262                                  
   263                                  continue:                     ;invalid input jumps to this part
   264 00000193 F2410F10C6              movsd xmm0, xmm14              ;power return to caller.
   265                                  
   266                                  ;=================================================================================================================
   267                                  
   268                                  
   269                                  ;===== Restore backed up registers ===============================================================================
   270 00000198 9D                      popf                                                        ;Restore rflags
   271 00000199 5B                      pop rbx                                                     ;Restore rbx
   272 0000019A 415F                    pop r15                                                     ;Restore r15
   273 0000019C 415E                    pop r14                                                     ;Restore r14
   274 0000019E 415D                    pop r13                                                     ;Restore r13
   275 000001A0 415C                    pop r12                                                     ;Restore r12
   276 000001A2 415B                    pop r11                                                     ;Restore r11
   277 000001A4 415A                    pop r10                                                     ;Restore r10
   278 000001A6 4159                    pop r9                                                      ;Restore r9
   279 000001A8 4158                    pop r8                                                      ;Restore r8
   280 000001AA 59                      pop rcx                                                     ;Restore rcx
   281 000001AB 5A                      pop rdx                                                     ;Restore rdx
   282 000001AC 5E                      pop rsi                                                     ;Restore rsi
   283 000001AD 5F                      pop rdi                                                     ;Restore rdi
   284 000001AE 5D                      pop rbp                                                     ;Restore rbp
   285                                  
   286 000001AF C3                      ret
   287                                  
   288                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2=========3**
